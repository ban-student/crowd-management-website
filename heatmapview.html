<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heatmap View - Crowd Analytics</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #ff9933 0%, #ffffff 50%, #138808 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, #ff6b35, #ff9f43);
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 20px rgba(255, 107, 53, 0.3);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .back-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }
        
        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateX(-5px);
        }
        
        .header-title {
            color: white;
        }
        
        .header-title h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .header-title p {
            opacity: 0.9;
            font-size: 1rem;
        }
        
        .live-indicator {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        
        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        .controls-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #ff6b35, #ff9f43);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981, #34d399);
            color: white;
        }
        
        .btn-camera {
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .map-view {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            margin-bottom: 30px;
        }
        
        .map-placeholder {
            width: 100%;
            height: 400px;
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #6b7280;
            border: 2px dashed #d1d5db;
            position: relative;
            overflow: hidden;
        }
        
        .map-placeholder::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="25" cy="25" r="3" fill="%23ef4444" opacity="0.3"/><circle cx="75" cy="25" r="3" fill="%23f59e0b" opacity="0.3"/><circle cx="25" cy="75" r="3" fill="%2310b981" opacity="0.3"/><circle cx="75" cy="75" r="3" fill="%2310b981" opacity="0.3"/><circle cx="50" cy="50" r="3" fill="%23f59e0b" opacity="0.3"/></svg>') repeat;
            opacity: 0.5;
        }

        /* Camera Heatmap Section Styles */
        .camera-heatmap-view {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            margin-bottom: 30px;
        }

        .camera-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .camera-feed-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .camera-feed {
            width: 100%;
            height: 450px;
            background: linear-gradient(135deg, #1f2937, #374151);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-size: 1.1rem;
            position: relative;
        }

        .heatmap-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0.7;
            background: radial-gradient(circle at 30% 40%, rgba(239, 68, 68, 0.6) 0%, transparent 25%),
                        radial-gradient(circle at 70% 30%, rgba(245, 158, 11, 0.5) 0%, transparent 20%),
                        radial-gradient(circle at 60% 70%, rgba(16, 185, 129, 0.4) 0%, transparent 15%),
                        radial-gradient(circle at 20% 80%, rgba(239, 68, 68, 0.5) 0%, transparent 18%);
            transition: opacity 0.3s ease;
        }

        .camera-status {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .camera-info {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .heatmap-settings {
            margin-top: 25px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .setting-group {
            text-align: left;
        }

        .setting-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            display: block;
        }

        .setting-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .setting-range {
            width: 100%;
            margin-top: 5px;
        }

        .detection-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(168, 85, 247, 0.1));
            border-radius: 15px;
        }

        .detection-stat {
            text-align: center;
        }

        .detection-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: #8b5cf6;
        }

        .detection-label {
            font-size: 0.9rem;
            color: #6b7280;
            font-weight: 600;
        }

        .heatmap-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .heatmap-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .heatmap-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2d3748;
        }
        
        .legend {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
        }
        
        .legend-safe { background: #10b981; }
        .legend-warning { background: #f59e0b; }
        .legend-critical { background: #ef4444; }
        
        .zones-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .zone-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border-left: 5px solid;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .zone-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .zone-safe { border-left-color: #10b981; }
        .zone-warning { border-left-color: #f59e0b; }
        .zone-critical { border-left-color: #ef4444; }
        
        .zone-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .zone-id {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
        }
        
        .zone-status {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-safe {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }
        
        .status-warning {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
        }
        
        .status-critical {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            animation: blink 1.5s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .zone-name {
            font-size: 1.1rem;
            color: #4a5568;
            margin-bottom: 10px;
        }
        
        .zone-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .metric {
            text-align: center;
        }
        
        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 0.8rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .occupancy-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .occupancy-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 1s ease-in-out;
        }
        
        .fill-safe { background: #10b981; }
        .fill-warning { background: #f59e0b; }
        .fill-critical { background: #ef4444; }
        
        .gps-coordinates {
            font-size: 0.8rem;
            color: #9ca3af;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .stats-summary {
            background: linear-gradient(135deg, rgba(255, 107, 53, 0.1), rgba(19, 136, 8, 0.1));
            border-radius: 15px;
            padding: 25px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }
        
        .summary-stat {
            text-align: center;
        }
        
        .summary-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .summary-label {
            font-size: 1rem;
            color: #4a5568;
            font-weight: 600;
        }
        
        .total-people { color: #ff6b35; }
        .avg-occupancy { color: #667eea; }
        .peak-zone { color: #ef4444; }
        .safe-zones { color: #10b981; }
        
        .leaflet-container {
            border-radius: 15px;
        }

        .heatmap-marker {
            background: radial-gradient(circle, rgba(239, 68, 68, 0.8) 0%, transparent 70%);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            border: 2px solid #ef4444;
        }

        .warning-marker {
            background: radial-gradient(circle, rgba(245, 158, 11, 0.8) 0%, transparent 70%);
            border: 2px solid #f59e0b;
        }

        .safe-marker {
            background: radial-gradient(circle, rgba(16, 185, 129, 0.8) 0%, transparent 70%);
            border: 2px solid #10b981;
        }
        
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .controls-panel {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .zones-grid {
                grid-template-columns: 1fr;
            }
            
            .heatmap-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .legend {
                justify-content: center;
            }

            .camera-controls {
                flex-direction: column;
                align-items: center;
            }

            .heatmap-settings {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <button class="back-button" onclick="goBack()">‚Üê Back</button>
            <div class="header-title">
                <h1>üó∫ Heatmap View</h1>
                <p>Real-time crowd density visualization</p>
            </div>
        </div>
        <div class="live-indicator">
            <div class="status-dot"></div>
            <span>LIVE</span>
        </div>
    </header>

    <div class="container">
        <div class="controls-panel">
            <div class="control-group">
                <button class="btn btn-primary" onclick="refreshData()">üîÑ Refresh</button>
                <button class="btn btn-secondary" onclick="autoRefresh()">‚ö° Auto Refresh</button>
                <button class="btn btn-success" onclick="exportData()">üìä Export CSV</button>
            </div>
            <div class="control-group">
                <span style="color: #6b7280; font-weight: 500;">Last Updated:</span>
                <span id="lastUpdated" style="color: #2d3748; font-weight: 600;">--</span>
            </div>
        </div>
        
        <!-- 1. Camera Heatmap Section (First) -->
        <div class="camera-heatmap-view">
            <h3 style="margin-bottom: 20px; color: #2d3748; font-size: 1.8rem; font-weight: 700;">üé• Camera-Based Heatmap Analysis</h3>
            
            <div class="camera-controls">
                <button class="btn btn-camera" onclick="startCameraFeed()">üìπ Start Camera</button>
                <button class="btn btn-secondary" onclick="stopCameraFeed()">‚èπ Stop Camera</button>
                <button class="btn btn-primary" onclick="toggleHeatmapOverlay()">üî• Toggle Heatmap</button>
                <button class="btn btn-success" onclick="captureSnapshot()">üì∏ Capture</button>
            </div>

            <div class="camera-feed-container">
                <div class="camera-feed" id="cameraFeed">
                    <div>
                        <div style="font-size: 3rem; margin-bottom: 10px;">üìπ</div>
                        <p>Camera feed will appear here</p>
                        <p style="font-size: 0.9rem; margin-top: 10px; opacity: 0.7;">Click "Start Camera" to begin live crowd detection</p>
                    </div>
                    
                    <div class="heatmap-overlay" id="heatmapOverlay" style="opacity: 0;"></div>
                    
                    <div class="camera-status" id="cameraStatus" style="display: none;">
                        <div class="status-dot"></div>
                        <span>RECORDING</span>
                    </div>
                    
                    <div class="camera-info" id="cameraInfo" style="display: none;">
                        <div>Resolution: 1280x720</div>
                        <div>FPS: <span id="fps">30</span></div>
                        <div>Detected: <span id="detectedCount">0</span> people</div>
                    </div>
                </div>
            </div>

            <div class="heatmap-settings">
                <div class="setting-group">
                    <label class="setting-label">Sensitivity</label>
                    <input type="range" class="setting-range" min="1" max="10" value="7" id="sensitivity">
                    <div style="font-size: 0.8rem; color: #6b7280; margin-top: 5px;">Current: <span id="sensitivityValue">7</span></div>
                </div>
                <div class="setting-group">
                    <label class="setting-label">Heat Intensity</label>
                    <input type="range" class="setting-range" min="0" max="100" value="70" id="heatIntensity">
                    <div style="font-size: 0.8rem; color: #6b7280; margin-top: 5px;">Current: <span id="heatIntensityValue">70</span>%</div>
                </div>
                <div class="setting-group">
                    <label class="setting-label">Detection Threshold</label>
                    <select class="setting-input" id="detectionThreshold">
                        <option value="low">Low - More Sensitive</option>
                        <option value="medium" selected>Medium - Balanced</option>
                        <option value="high">High - Less Noise</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label class="setting-label">Camera Source</label>
                    <select class="setting-input" id="cameraSource">
                        <option value="default">Default Camera</option>
                        <option value="camera1">Camera 1 - Main Hall</option>
                        <option value="camera2">Camera 2 - Entry Gate</option>
                        <option value="camera3">Camera 3 - Food Court</option>
                    </select>
                </div>
            </div>

            <div class="detection-stats">
                <div class="detection-stat">
                    <div class="detection-number" id="totalDetected">0</div>
                    <div class="detection-label">Total Detected</div>
                </div>
                <div class="detection-stat">
                    <div class="detection-number" id="avgDensity">0%</div>
                    <div class="detection-label">Avg Density</div>
                </div>
                <div class="detection-stat">
                    <div class="detection-number" id="hotSpots">0</div>
                    <div class="detection-label">Hot Spots</div>
                </div>
                <div class="detection-stat">
                    <div class="detection-number" id="alertLevel">LOW</div>
                    <div class="detection-label">Alert Level</div>
                </div>
            </div>
        </div>
        
        <!-- 2. Interactive Zone Map (Second) -->
        <div class="map-view">
            <h3 style="margin-bottom: 20px; color: #2d3748; font-size: 1.8rem; font-weight: 700;">üó∫Ô∏è Interactive Zone Map</h3>
            <div id="map" style="width: 100%; height: 400px; border-radius: 15px;"></div>
        </div>

        <!-- 3. Zone Density Overview (Third) -->
        <div class="heatmap-container">
            <div class="heatmap-header">
                <h2 class="heatmap-title">Zone Density Overview</h2>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color legend-safe"></div>
                        <span>Safe (< 75%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-warning"></div>
                        <span>Warning (75-90%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color legend-critical"></div>
                        <span>Critical (> 90%)</span>
                    </div>
                </div>
            </div>

            <div class="zones-grid" id="zonesGrid">
                <!-- Zones will be populated by JavaScript -->
            </div>
        </div>

        <div class="stats-summary">
            <div class="summary-stat">
                <div class="summary-number total-people" id="totalPeople">--</div>
                <div class="summary-label">Total People Detected</div>
            </div>
            <div class="summary-stat">
                <div class="summary-number avg-occupancy" id="avgOccupancy">--</div>
                <div class="summary-label">Average Zone Occupancy</div>
            </div>
            <div class="summary-stat">
                <div class="summary-number peak-zone" id="peakZone">--</div>
                <div class="summary-label">Most Crowded Zone</div>
            </div>
            <div class="summary-stat">
                <div class="summary-number safe-zones" id="safeZones">--</div>
                <div class="summary-label">Safe Zones Count</div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
    
    <script>
        // API Configuration
        const API_BASE = 'http://localhost:5000/api';
        let autoRefreshInterval = null;
        let isAutoRefresh = false;
        let isCameraActive = false;
        let isHeatmapVisible = false;
        let cameraInterval = null;
        let cameraUpdateInterval = null;
        
        // Map variables
        let map = null;
        let heatLayer = null;

        // Mock data for demonstration
        const mockHeatmapData = [
            {
                zone_id: 'A',
                zone_name: 'Main Entry Gate',
                occupancy_rate: 85,
                current_count: 425,
                capacity: 500,
                coordinates: [28.6139, 77.2090],
                status: 'warning'
            },
            {
                zone_id: 'B',
                zone_name: 'Food Court Area',
                occupancy_rate: 95,
                current_count: 285,
                capacity: 300,
                coordinates: [28.6129, 77.2100],
                status: 'critical'
            },
            {
                zone_id: 'C',
                zone_name: 'Exhibition Hall',
                occupancy_rate: 65,
                current_count: 520,
                capacity: 800,
                coordinates: [28.6149, 77.2080],
                status: 'safe'
            },
            {
                zone_id: 'D',
                zone_name: 'Parking Zone',
                occupancy_rate: 45,
                current_count: 90,
                capacity: 200,
                coordinates: [28.6119, 77.2110],
                status: 'safe'
            },
            {
                zone_id: 'E',
                zone_name: 'Emergency Exit',
                occupancy_rate: 25,
                current_count: 38,
                capacity: 150,
                coordinates: [28.6159, 77.2070],
                status: 'safe'
            }
        ];

        // Navigation functions
        function goBack() {
            window.location.href = 'analyticsdashboard.html';
        }

        // Data fetching
        async function fetchHeatmapData() {
            try {
                const response = await fetch(`${API_BASE}/heatmap`);
                if (response.ok) {
                    const data = await response.json();
                    return data.heatmap_data || mockHeatmapData;
                } else {
                    throw new Error('API not available');
                }
            } catch (error) {
                console.log('Using mock data');
                return mockHeatmapData;
            }
        }

        // Update zones display
        function updateZonesDisplay(zones) {
            const zonesGrid = document.getElementById('zonesGrid');
            zonesGrid.innerHTML = '';

            zones.forEach(zone => {
                const statusClass = zone.occupancy_rate > 90 ? 'critical' : 
                                  zone.occupancy_rate > 75 ? 'warning' : 'safe';
                
                const fillClass = `fill-${statusClass}`;
                
                const zoneCard = document.createElement('div');
                zoneCard.className = `zone-card zone-${statusClass}`;
                zoneCard.onclick = () => showZoneDetails(zone);
                
                zoneCard.innerHTML = `
                    <div class="zone-header">
                        <div class="zone-id">Zone ${zone.zone_id}</div>
                        <div class="zone-status status-${statusClass}">${statusClass}</div>
                    </div>
                    <div class="zone-name">${zone.zone_name}</div>
                    <div class="zone-metrics">
                        <div class="metric">
                            <div class="metric-value" style="color: #ff6b35;">${zone.current_count}</div>
                            <div class="metric-label">Current</div>
                        </div>
                        <div class="metric">
                            <div class="metric-value" style="color: #667eea;">${zone.capacity}</div>
                            <div class="metric-label">Capacity</div>
                        </div>
                    </div>
                    <div class="occupancy-bar">
                        <div class="occupancy-fill ${fillClass}" style="width: ${zone.occupancy_rate}%"></div>
                    </div>
                    <div style="text-align: center; font-size: 1.2rem; font-weight: 700; color: #2d3748;">
                        ${zone.occupancy_rate}% Occupied
                    </div>
                    <div class="gps-coordinates">
                        üìç ${zone.coordinates[0].toFixed(4)}, ${zone.coordinates[1].toFixed(4)}
                    </div>
                `;
                
                zonesGrid.appendChild(zoneCard);
            });

            updateSummaryStats(zones);
            updateLastUpdated();
        }

        function updateSummaryStats(zones) {
            const totalPeople = zones.reduce((sum, zone) => sum + zone.current_count, 0);
            const avgOccupancy = zones.reduce((sum, zone) => sum + zone.occupancy_rate, 0) / zones.length;
            const peakZone = zones.reduce((max, zone) => zone.occupancy_rate > max.occupancy_rate ? zone : max);
            const safeZonesCount = zones.filter(zone => zone.occupancy_rate < 75).length;

            document.getElementById('totalPeople').textContent = totalPeople.toLocaleString();
            document.getElementById('avgOccupancy').textContent = `${avgOccupancy.toFixed(1)}%`;
            document.getElementById('peakZone').textContent = `Zone ${peakZone.zone_id}`;
            document.getElementById('safeZones').textContent = `${safeZonesCount}/${zones.length}`;
        }

        // Update last updated timestamp
        function updateLastUpdated() {
            const now = new Date();
            document.getElementById('lastUpdated').textContent = now.toLocaleTimeString();
        }

        // Show zone details
        function showZoneDetails(zone) {
            const statusIcon = zone.occupancy_rate > 90 ? 'üö®' : 
                              zone.occupancy_rate > 75 ? '‚ö†' : '‚úÖ';
            
            alert(`${statusIcon} Zone ${zone.zone_id} Details:\n\n` +
                  `Name: ${zone.zone_name}\n` +
                  `Current Count: ${zone.current_count} people\n` +
                  `Capacity: ${zone.capacity} people\n` +
                  `Occupancy Rate: ${zone.occupancy_rate}%\n` +
                  `Status: ${zone.status.toUpperCase()}\n` +
                  `GPS Coordinates: ${zone.coordinates[0]}, ${zone.coordinates[1]}\n\n` +
                  `Click OK to view more details or take action.`);
        }

        // Control functions
        async function refreshData() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = 'üîÑ Refreshing...';
            btn.disabled = true;

            try {
                const zones = await fetchHeatmapData();
                updateZonesDisplay(zones);
                if (map) {
                    updateMapHeatmap(zones);
                }
            } catch (error) {
                console.error('Refresh failed:', error);
            } finally {
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 1000);
            }
        }

        function autoRefresh() {
            const btn = event.target;
            
            if (!isAutoRefresh) {
                isAutoRefresh = true;
                btn.innerHTML = '‚è∏ Stop Auto';
                btn.style.background = 'linear-gradient(135deg, #ef4444, #f87171)';
                
                autoRefreshInterval = setInterval(async () => {
                    const zones = await fetchHeatmapData();
                    updateZonesDisplay(zones);
                    if (map) {
                        updateMapHeatmap(zones);
                    }
                }, 5000);
            } else {
                isAutoRefresh = false;
                btn.innerHTML = '‚ö° Auto Refresh';
                btn.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
                
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }

        function exportData() {
            const zones = mockHeatmapData;
            const csvContent = "data:text/csv;charset=utf-8," +
                "Zone ID,Zone Name,Current Count,Capacity,Occupancy Rate,Status,Latitude,Longitude\n" +
                zones.map(zone => 
                    `${zone.zone_id},"${zone.zone_name}",${zone.current_count},${zone.capacity},${zone.occupancy_rate}%,${zone.status},${zone.coordinates[0]},${zone.coordinates[1]}`
                ).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `heatmap_data_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚úÖ Exported!';
            setTimeout(() => {
                btn.innerHTML = originalText;
            }, 2000);
        }

        // Map initialization
        function initializeMap() {
            map = L.map('map').setView([28.6139, 77.2090], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            const zones = mockHeatmapData;
            zones.forEach(zone => {
                const markerClass = zone.occupancy_rate > 90 ? 'heatmap-marker' : 
                                   zone.occupancy_rate > 75 ? 'warning-marker' : 'safe-marker';
                
                const marker = L.marker([zone.coordinates[0], zone.coordinates[1]], {
                    icon: L.divIcon({
                        className: markerClass,
                        html: `<div style="text-align: center; font-weight: bold; color: white; line-height: 26px;">${zone.zone_id}</div>`,
                        iconSize: [30, 30],
                        iconAnchor: [15, 15]
                    })
                }).addTo(map);
                
                marker.bindPopup(`
                    <strong>Zone ${zone.zone_id}</strong><br>
                    ${zone.zone_name}<br>
                    <strong>Occupancy:</strong> ${zone.occupancy_rate}%<br>
                    <strong>People:</strong> ${zone.current_count}/${zone.capacity}<br>
                    <strong>Status:</strong> ${zone.status.toUpperCase()}
                `);
            });
            
            updateMapHeatmap(zones);
        }

        function updateMapHeatmap(zones) {
            if (heatLayer) {
                map.removeLayer(heatLayer);
            }
            
            const heatData = zones.map(zone => [
                zone.coordinates[0],
                zone.coordinates[1],
                zone.occupancy_rate / 100
            ]);
            
            heatLayer = L.heatLayer(heatData, {
                radius: 100,
                blur: 15,
                maxZoom: 17,
                gradient: {
                    0.2: '#10b981',
                    0.5: '#f59e0b',
                    0.8: '#ef4444',
                    1.0: '#dc2626'
                }
            }).addTo(map);
        }

        // Camera functions
        async function startCameraFeed() {
            if (isCameraActive) return;
            
            try {
                const response = await fetch('/api/heatmap/start_camera', { method: 'POST' });
                const result = await response.json();
                
                if (result.status === 'success' || result.status === 'already_running') {
                    isCameraActive = true;
                    const cameraFeed = document.getElementById('cameraFeed');
                    const cameraStatus = document.getElementById('cameraStatus');
                    const cameraInfo = document.getElementById('cameraInfo');
                    
                    cameraFeed.innerHTML = `
                        <img id="cameraImage" style="width: 100%; height: 100%; object-fit: cover;" src="" alt="Camera Feed">
                    `;
                    
                    cameraStatus.style.display = 'flex';
                    cameraInfo.style.display = 'block';
                    
                    cameraUpdateInterval = setInterval(updateCameraFrame, 200);
                    
                    const btn = event.target;
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '‚úÖ Camera Started!';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                    }, 2000);
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('Error starting camera:', error);
                alert('Failed to start camera: ' + error.message);
            }
        }

        async function stopCameraFeed() {
            if (!isCameraActive) return;
            
            try {
                const response = await fetch('/api/heatmap/stop_camera', { method: 'POST' });
                const result = await response.json();
                
                if (result.status === 'success') {
                    isCameraActive = false;
                    const cameraFeed = document.getElementById('cameraFeed');
                    const cameraStatus = document.getElementById('cameraStatus');
                    const cameraInfo = document.getElementById('cameraInfo');
                    
                    cameraFeed.innerHTML = `
                        <div>
                            <div style="font-size: 3rem; margin-bottom: 10px;">üìπ</div>
                            <p>Camera feed stopped</p>
                            <p style="font-size: 0.9rem; margin-top: 10px; opacity: 0.7;">Click "Start Camera" to begin live crowd detection</p>
                        </div>
                    `;
                    
                    cameraStatus.style.display = 'none';
                    cameraInfo.style.display = 'none';
                    
                    if (cameraUpdateInterval) {
                        clearInterval(cameraUpdateInterval);
                        cameraUpdateInterval = null;
                    }
                    
                    updateDetectionStats(0, '0%', 0, 'LOW');
                    
                    const btn = event.target;
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '‚úÖ Camera Stopped!';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                    }, 2000);
                }
            } catch (error) {
                console.error('Error stopping camera:', error);
            }
        }

        async function updateCameraFrame() {
            if (!isCameraActive) return;
            
            try {
                const response = await fetch('/api/heatmap/frame');
                const result = await response.json();
                
                if (result.status === 'success' && result.frame) {
                    const cameraImage = document.getElementById('cameraImage');
                    if (cameraImage) {
                        cameraImage.src = result.frame;
                    }
                    
                    const fps = Math.floor(Math.random() * 5) + 28;
                    document.getElementById('fps').textContent = fps;
                    document.getElementById('detectedCount').textContent = result.people_count;
                    
                    updateDetectionStatsFromAPI();
                }
            } catch (error) {
                console.error('Error updating camera frame:', error);
            }
        }

        async function updateDetectionStatsFromAPI() {
            try {
                const response = await fetch('/api/heatmap/stats');
                const stats = await response.json();
                
                updateDetectionStats(
                    stats.total_detected,
                    stats.avg_density,
                    stats.hot_spots,
                    stats.alert_level
                );
            } catch (error) {
                console.error('Error fetching detection stats:', error);
            }
        }

        function updateDetectionStats(totalDetected, avgDensity, hotSpots, alertLevel) {
            document.getElementById('totalDetected').textContent = totalDetected;
            document.getElementById('avgDensity').textContent = avgDensity;
            document.getElementById('hotSpots').textContent = hotSpots;
            document.getElementById('alertLevel').textContent = alertLevel;
            document.getElementById('alertLevel').style.color = 
                alertLevel === 'HIGH' ? '#ef4444' : alertLevel === 'MED' ? '#f59e0b' : '#10b981';
        }

        function toggleHeatmapOverlay() {
            const heatmapOverlay = document.getElementById('heatmapOverlay');
            isHeatmapVisible = !isHeatmapVisible;
            
            heatmapOverlay.style.opacity = isHeatmapVisible ? '0.7' : '0';
            
            const btn = event.target;
            btn.innerHTML = isHeatmapVisible ? 'üî• Heatmap ON' : 'üî• Heatmap OFF';
            btn.style.background = isHeatmapVisible ? 
                'linear-gradient(135deg, #ef4444, #f87171)' : 
                'linear-gradient(135deg, #ff6b35, #ff9f43)';
        }

        function captureSnapshot() {
            if (!isCameraActive) {
                alert('‚ö† Please start the camera first to capture a snapshot.');
                return;
            }
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = 'üì∏ Capturing...';
            btn.disabled = true;
            
            setTimeout(() => {
                btn.innerHTML = '‚úÖ Captured!';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 1500);
                
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                alert(`üì∏ Snapshot captured successfully!\nSaved as: heatmap_snapshot_${timestamp}.jpg`);
            }, 1000);
        }

        // Camera settings function
        async function updateCameraSettings(setting, value) {
            try {
                const response = await fetch('/api/heatmap/update_settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [setting]: value })
                });
                const result = await response.json();
                if (result.status === 'success') {
                    console.log(`Updated ${setting} to ${value}`);
                }
            } catch (error) {
                console.log('Settings update failed:', error);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            const zones = await fetchHeatmapData();
            updateZonesDisplay(zones);
            
            // Initialize map after a short delay
            setTimeout(initializeMap, 1000);
            
            // Add animation delays to zone cards
            const zoneCards = document.querySelectorAll('.zone-card');
            zoneCards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                card.style.transition = 'all 0.6s ease';
                
                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 100);
            });
            
            // Camera settings event listeners
            const sensitivitySlider = document.getElementById('sensitivity');
            const sensitivityValue = document.getElementById('sensitivityValue');
            sensitivitySlider.addEventListener('input', (e) => {
                sensitivityValue.textContent = e.target.value;
                if (isCameraActive) {
                    updateCameraSettings('sensitivity', parseInt(e.target.value));
                }
            });
            
            const heatIntensitySlider = document.getElementById('heatIntensity');
            const heatIntensityValue = document.getElementById('heatIntensityValue');
            heatIntensitySlider.addEventListener('input', (e) => {
                heatIntensityValue.textContent = e.target.value;
                const overlay = document.getElementById('heatmapOverlay');
                if (overlay) {
                    overlay.style.opacity = isHeatmapVisible ? (e.target.value / 100 * 0.7) : '0';
                }
                if (isCameraActive) {
                    updateCameraSettings('heat_intensity', parseInt(e.target.value));
                }
            });
            
            const detectionThreshold = document.getElementById('detectionThreshold');
            detectionThreshold.addEventListener('change', (e) => {
                if (isCameraActive) {
                    updateCameraSettings('threshold', e.target.value);
                }
            });
            
            const cameraSource = document.getElementById('cameraSource');
            cameraSource.addEventListener('change', (e) => {
                if (isCameraActive) {
                    updateCameraSettings('camera_source', e.target.value);
                    alert('Camera source changed. Restart camera to apply changes.');
                }
            });
        });

        // Handle page visibility for auto-refresh
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && isAutoRefresh) {
                clearInterval(autoRefreshInterval);
            } else if (!document.hidden && isAutoRefresh) {
                autoRefreshInterval = setInterval(async () => {
                    const zones = await fetchHeatmapData();
                    updateZonesDisplay(zones);
                    if (map) {
                        updateMapHeatmap(zones);
                    }
                }, 5000);
            }
            
            if (document.hidden && isCameraActive) {
                if (cameraUpdateInterval) {
                    clearInterval(cameraUpdateInterval);
                }
            } else if (!document.hidden && isCameraActive) {
                cameraUpdateInterval = setInterval(updateCameraFrame, 200);
            }
        });
    </script>
</body>
</html>
